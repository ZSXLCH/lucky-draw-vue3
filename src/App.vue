<template>
  <div id="root">
    <header>
      <Publicity v-show="!running" />
      <el-button
        class="audio"
        type="text"
        @click="playAudio(!audioPlaying)"
      >
        <i
          class="iconfont"
          :class="[audioPlaying ? 'iconstop' : 'iconplay1']"
        ></i>
      </el-button>
      <el-button class="res" type="text" @click="showResult = true">
        抽奖结果
      </el-button>
      <el-button class="con" type="text" @click="showConfig = true">
        抽奖配置
      </el-button>
    </header>
    <div id="main" :class="{ mask: showRes || showDrawCard }"></div>
    <div id="tags">
      <ul v-for="item in datas" :key="item.key">
        <li>
          <a
            href="javascript:void(0);"
            :style="{
              color: item.winner ? '#ffd700' : '#fff',
            }"
          >
            {{ item.name ? item.name : item.key }}
            <img v-if="item.photo" :src="item.photo" :width="50" :height="50" />
          </a>
        </li>
      </ul>
    </div>
    <!-- 堆叠卡片抽奖结果 -->
    <transition name="fade">
      <div v-show="showDrawCard" id="stackedCardContainer">
        <div class="card-stack">
          <!-- 只渲染顶部卡片，确保状态控制精确 -->
          <div 
            v-if="remainingCards.length > 0"
            class="stacked-card active"
            :class="{
              'flipped': isTopCardFlipped,
              'flying-out': isTopCardFlyingOut
            }"
            :style="{
              zIndex: 1000,
              transform: '',
              boxShadow: '0 8px 32px rgba(255, 215, 0, 0.3)'
            }"
            @click="handleTopCardClick()"
          >
            <div class="card-inner">
              <!-- 正面：点击揭晓 -->
              <div class="card-front">
                <div class="card-content">
                  <h2>点击揭晓</h2>
                  <p>{{ resArr.length - remainingCards.length + 1 }} / {{ resArr.length }}</p>
                </div>
              </div>
              <!-- 背面：中奖信息 -->
              <div class="card-back">
                <div class="card-content">
                  <p class="winner-name">{{ getWinnerInfo(remainingCards[0])?.type || '-' }}：{{ getWinnerInfo(remainingCards[0])?.name || '' }}</p>
                  <img v-if="getWinnerInfo(remainingCards[0])?.photo" :src="getWinnerInfo(remainingCards[0]).photo" class="winner-photo" />
                </div>
              </div>
            </div>
          </div>
          
          <!-- 渲染堆叠在下面的卡片（只显示视觉效果） -->
          <div 
            v-for="(cardKey, index) in remainingCards.slice(1)" 
            :key="index"
            class="stacked-card"
            :style="{
              zIndex: 999 - index,
              transform: `translateY(-${(index + 1) * 10}px) rotate(${(index + 1) * 2}deg)`,
              boxShadow: `0 ${(index + 1) * 2}px ${(index + 1) * 4}px rgba(0, 0, 0, 0.3)`
            }"
          >
            <div class="card-inner">
              <!-- 只显示点击揭晓的正面 -->
              <div class="card-front">
                <div class="card-content">
                  <h2>点击揭晓</h2>
                  <p>{{ resArr.length - remainingCards.length + index + 2 }} / {{ resArr.length }}</p>
                </div>
              </div>
              <!-- 背面不需要渲染，因为下层卡片不会被翻转 -->
              <div class="card-back">
                <div class="card-content">
                  <!-- 空白内容 -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </transition>
    
    <transition name="bounce">
      <div id="resbox" v-show="showRes">
        <div class="resbox-header">
          <p>{{ categoryName }}抽奖结果：</p>
          <button class="close-button" @click="showRes = false">×</button>
        </div>
        <div v-if="currentPageData.length > 0">
          <div class="grid-container">
            <div 
              v-for="(res, i) in currentPageData" 
              :key="i" 
              class="grid-item"
            >
              <span class="result-text">
                {{ (list.find((d) => d.key === res) || {}).type || '-' }}：{{ (list.find((d) => d.key === res) || {}).name || res }}
              </span>
            </div>
          </div>
          <div v-if="totalPages > 1" class="pagination-container">
              <el-pagination
                v-model:current-page="currentPage"
                :page-size="pageSize"
                layout="prev, pager, next"
                :total="resArr.length"
                @current-change="handlePageChange"
              />
          </div>
        </div>
      </div>
    </transition>

    <LotteryConfig v-model:visible="showConfig" @resetconfig="reloadTagCanvas" />
    <Tool
      @toggle="toggle"
      @resetConfig="reloadTagCanvas"
      @getPhoto="getPhoto"
      :running="running"
      :closeRes="closeRes"
    />
    <Result v-model:visible="showResult"></Result>
    
    <audio
      id="audiobg"
      preload="auto"
      controls
      autoplay
      loop
      @play="playHandler"
      @pause="pauseHandler"
    >
      <source :src="audioSrc" />
      你的浏览器不支持audio标签
    </audio>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onBeforeUnmount, nextTick, watch } from 'vue';
import { useLuckyStore } from '@/stores';
import LotteryConfig from '@/components/LotteryConfig.vue';
import Publicity from '@/components/Publicity.vue';
import Tool from '@/components/Tool.vue';
import bgaudio from '@/assets/bg.mp3';
import beginaudio from '@/assets/begin.mp3';
import {
  getData,
  configField,
  resultField,
  newLotteryField,
  conversionCategoryName,
  listField,
} from '@/helper/index';
import { luckydrawHandler } from '@/helper/algorithm';
import Result from '@/components/Result.vue';
import { database, DB_STORE_NAME } from '@/helper/db';

// 状态管理
const store = useLuckyStore();

// 响应式数据
const running = ref(false);
const showRes = ref(false);
const showConfig = ref(false);
const showResult = ref(false);
const resArr = ref([]);
const category = ref('');
const audioPlaying = ref(false);
const audioSrc = ref(bgaudio);

// 堆叠卡片相关状态
const showDrawCard = ref(false);
const remainingCards = ref([]); // 剩余的卡片数组
const isTopCardFlipped = ref(false);
const isTopCardFlyingOut = ref(false);

// 分页相关数据
const pageSize = 14; // 固定每页最多显示14个
const currentPage = ref(1);

// 计算属性
const totalPages = computed(() => Math.ceil(resArr.value.length / pageSize));
const currentPageData = computed(() => {
  const startIndex = (currentPage.value - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  return resArr.value.slice(startIndex, endIndex);
});

// 获取中奖者信息
const getWinnerInfo = (winnerKey) => {
  const winnerInfo = list.value.find((d) => d.key === winnerKey) || {};
  const photoInfo = photos.value.find((d) => d.id === winnerKey);
  return {
    ...winnerInfo,
    photo: photoInfo ? photoInfo.value : ''
  };
};

// 处理页码变化
const handlePageChange = (page) => {
  currentPage.value = page;
};

// 计算属性
const resCardStyle = computed(() => {
  const style = { fontSize: '30px' };
  const { number } = store.config;
  if (number < 100) {
    style.fontSize = '100px';
  } else if (number < 1000) {
    style.fontSize = '80px';
  } else if (number < 10000) {
    style.fontSize = '60px';
  }
  return style;
});

const config = computed(() => store.config);
const result = computed({
  get: () => store.result,
  set: (val) => store.setResult(val)
});
const list = computed(() => store.list);
const photos = computed(() => store.photos);

const allresult = computed(() => {
  let results = [];
  for (const key in result.value) {
    if (Object.prototype.hasOwnProperty.call(result.value, key)) {
      const element = result.value[key];
      results = results.concat(element);
    }
  }
  return results;
});

const datas = computed(() => {
  const { number } = config.value;
  const nums = number >= 1500 ? 500 : number;
  const configNum = number > 1500 ? Math.floor(number / 3) : number;
  const randomShowNums = luckydrawHandler(configNum, [], nums);
  const randomShowDatas = randomShowNums.map((item) => {
    const listData = list.value.find((d) => d.key === item);
    const photo = photos.value.find((d) => d.id === item);
    return {
      key: item * (number > 1500 ? 3 : 1),
      name: listData ? listData.name : '',
      photo: photo ? photo.value : '',
      winner: allresult.value.includes(item),
    };
  });
  return randomShowDatas;
});

const categoryName = computed(() => conversionCategoryName(category.value));

// 生命周期钩子
onMounted(() => {
  startTagCanvas();
  setTimeout(() => {
    getPhoto();
  }, 1000);
  window.addEventListener('resize', reportWindowSize);
});

onBeforeUnmount(() => {
  window.removeEventListener('resize', reportWindowSize);
});

// 监听窗口大小变化，动态调整字体大小
window.addEventListener('resize', () => {
  if (window.TagCanvas.IsLoaded('rootcanvas')) {
    const textHeight = calculateTextHeight();
    window.TagCanvas.SetOptions('rootcanvas', { textHeight: textHeight });
    window.TagCanvas.Reload('rootcanvas');
  }
});

// 初始化数据
const initData = () => {
  const data = getData(configField);
  if (data) {
    store.setConfig(Object.assign({}, data));
  }
  
  const resultData = getData(resultField);
  if (resultData) {
    store.setResult(resultData);
  }

  const newLottery = getData(newLotteryField);
  if (newLottery) {
    const configData = config.value;
    newLottery.forEach((item) => {
      store.setNewLottery(item);
      if (!configData[item.key]) {
        configData[item.key] = 0;
      }
    });
    store.setConfig(configData);
  }

  const listData = getData(listField);
  if (listData) {
    store.setList(listData);
  }
};
initData();

// 监听照片变化
watch(photos, () => {
  nextTick(() => {
    reloadTagCanvas();
  });
}, { deep: true });

// 新增：监听中奖结果变化，重新加载球体颜色
watch(result, () => {
  nextTick(() => {
    reloadTagCanvas();
  });
}, { deep: true });

// 方法
const reportWindowSize = () => {
  const AppCanvas = document.querySelector('#rootcanvas');
  if (AppCanvas && AppCanvas.parentElement) {
    AppCanvas.parentElement.removeChild(AppCanvas);
  }
  startTagCanvas();
};

const playHandler = () => {
  audioPlaying.value = true;
};

const pauseHandler = () => {
  audioPlaying.value = false;
};

const playAudio = (type) => {
  const audioBg = document.querySelector('#audiobg');
  if (type) {
    audioBg.play();
  } else {
    audioBg.pause();
  }
};

const loadAudio = () => {
  const audioBg = document.querySelector('#audiobg');
  audioBg.load();
  nextTick(() => {
    audioBg.play();
  });
};

const getPhoto = () => {
  database.getAll(DB_STORE_NAME).then((res) => {
    if (res && res.length > 0) {
      store.setPhotos(res);
    }
  });
};

const speed = () => {
  return [0.1 * Math.random() + 0.01, -(0.1 * Math.random() + 0.01)];
};

const createCanvas = () => {
  const canvas = document.createElement('canvas');
  canvas.width = document.body.offsetWidth;
  canvas.height = document.body.offsetHeight - 50; // header的高度
  canvas.id = 'rootcanvas';
  document.querySelector('#main').appendChild(canvas);
};

const calculateTextHeight = () => {
  // 获取总人数
  const totalPeople = config.value?.number || 1;
  // 获取窗口大小
  const windowWidth = window.innerWidth;
  const windowHeight = window.innerHeight;
  const screenSize = Math.min(windowWidth, windowHeight);
  
  // 基础字体大小
  let baseSize = 20;
  
  // 根据总人数调整字体大小：人数越多，字体越小
  if (totalPeople > 1000) {
    baseSize = 10;
  } else if (totalPeople > 500) {
    baseSize = 12;
  } else if (totalPeople > 200) {
    baseSize = 14;
  } else if (totalPeople > 100) {
    baseSize = 16;
  } else if (totalPeople > 50) {
    baseSize = 18;
  }
  
  // 根据屏幕大小调整字体大小：屏幕越大，字体可以适当增大
  const screenFactor = screenSize / 1920; // 基于1920px宽度的屏幕作为基准
  const finalSize = Math.max(8, Math.min(30, baseSize * (1 + (screenFactor - 0.5) * 0.5)));
  
  return finalSize;
};

const startTagCanvas = () => {
  createCanvas();
  const textHeight = calculateTextHeight();
  window.TagCanvas.Start('rootcanvas', 'tags', {
    textColour: null,
    initial: speed(),
    dragControl: 1,
    textHeight: textHeight,
    noSelect: true,
    lock: 'xy',
  });
};

const reloadTagCanvas = () => {
  window.TagCanvas.Reload('rootcanvas');
};

const closeRes = () => {
  showRes.value = false;
};

// 处理顶部卡片点击
const handleTopCardClick = () => {
  if (!isTopCardFlipped.value) {
    // 第一次点击：翻转卡片显示中奖者信息
    isTopCardFlipped.value = true;
  } else {
    // 第二次点击：卡片向左飞出
    isTopCardFlyingOut.value = true;
    
    // 动画完成后移除顶部卡片
    setTimeout(() => {
      // 先移除卡片
      remainingCards.value.shift();
      // 重置状态
      isTopCardFlipped.value = false;
      isTopCardFlyingOut.value = false;
      
      // 检查是否还有剩余卡片
      if (remainingCards.value.length === 0) {
        // 所有卡片都处理完了，显示完整中奖名单
        setTimeout(() => {
          showDrawCard.value = false;
          showRes.value = true;
        }, 300);
      }
      // 确保下一张卡片不会自动翻转
      // 通过Vue的响应式系统，下一张卡片会自然成为新的顶部卡片且默认不翻转
    }, 600); // 与CSS动画时间同步
  }
};

// 重置卡片状态
const resetCardState = () => {
  showDrawCard.value = false;
  remainingCards.value = [];
  isTopCardFlipped.value = false;
  isTopCardFlyingOut.value = false;
};

const toggle = (form) => {
  if (running.value) {
    // 停止抽奖时的逻辑
    audioSrc.value = bgaudio;
    loadAudio();

    // 只有在停止时才生成抽奖结果
    if (form) {
      const { number } = config.value;
      const { category: cat, mode, qty, remain, allin } = form;
      let num = 1;
      if (mode === 1 || mode === 5) {
        num = mode;
      } else if (mode === 0) {
        num = remain;
      } else if (mode === 99) {
        num = qty;
      }
      const resultArray = luckydrawHandler(
        number,
        allin ? [] : allresult.value,
        num,
        allin,
        form.groupDraw,
        list.value
      );
      resArr.value = resultArray;

      category.value = cat;
      if (!result.value[cat]) {
        result.value[cat] = [];
      }
      const oldRes = result.value[cat] || [];
      const data = Object.assign({}, result.value, {
        [cat]: oldRes.concat(resultArray),
      });
      result.value = data;
    }

    window.TagCanvas.SetSpeed('rootcanvas', speed());
    // 重置页码
    currentPage.value = 1;
    // 显示堆叠卡片效果
    resetCardState();
    // 初始化剩余卡片数组，复制resArr的值
    remainingCards.value = [...resArr.value];
    showDrawCard.value = true;
    running.value = !running.value;
    nextTick(() => {
      reloadTagCanvas();
    });
  } else {
    // 开始抽奖时只设置状态，不生成结果
    showRes.value = false;
    if (!form) {
      return;
    }

    audioSrc.value = beginaudio;
    loadAudio();
    window.TagCanvas.SetSpeed('rootcanvas', [5, 1]);
    running.value = !running.value;
  }
};
</script>

<style lang="scss">
#root {
  height: 100%;
  position: relative;
  background-image: url('./assets/bg1.jpg');
  background-size: 100% 100%;
  background-position: center center;
  background-repeat: no-repeat;
  background-color: #121936;
  .mask {
    -webkit-filter: blur(5px);
    filter: blur(5px);
  }
  header {
    height: 50px;
    line-height: 50px;
    position: relative;
    .el-button {
      position: absolute;
      top: 10px;
      padding: 0;
      z-index: 9999;
      &.con {
        right: 20px;
      }
      &.res {
        right: 100px;
      }
      &.audio {
        left: 20px;
        width: 40px;
        height: 40px;
        line-height: 40px;
        border: 1px solid #fff;
        border-radius: 50%;
        padding: 0;
        text-align: center;
        .iconfont {
          position: relative;
          left: 1px;
        }
      }
    }
  }
  .copy-right {
    position: absolute;
    right: 10px;
    bottom: 10px;
    color: #ccc;
    z-index: 1000;
    font-size: 12px;
  }
  #audiobg{
    position: absolute;
    left: 10px;
    bottom: -100px;
  }
  .bounce-enter-active {
    animation: bounce-in 1.5s;
  }
  .bounce-leave-active {
    animation: bounce-in 0s reverse;
  }
}
#main {
  height: 100%;
}

#resbox {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 980px;
  transform: translateX(-50%) translateY(-50%);
  text-align: center;
  z-index: 10000; /* 确保结果弹窗显示在最上层，高于右侧按钮的z-index: 9999 */
  .resbox-header {
      position: relative;
      text-align: center;
      margin-bottom: 20px;
      width: 100%;
      .close-button {
        position: absolute;
        top: 0;
        right: 0; /* 从左上改为右上 */
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #f00;
        color: #fff;
        border: none;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        &:hover {
          background-color: #d00;
        }
      }
      p {
          color: red;
          font-size: 22px;
          line-height: 30px;
          margin: 0;
        }
    }
  .container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
  }
  .itemres {
    background: #fff;
    width: 160px;
    height: 160px;
    border-radius: 4px;
    border: 1px solid #ccc;
    line-height: 160px;
    font-weight: bold;
    margin-right: 20px;
    margin-bottom: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    .cont {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    &.numberOver::before {
      content: attr(data-id);
      width: 30px;
      height: 22px;
      line-height: 22px;
      background-color: #fff;
      position: absolute;
      bottom: 0;
      left: 0;
      font-size: 14px;
      z-index: 1;
    }
  }
}
</style>

<style lang="scss">
#resbox {
  max-height: none;
  overflow-y: visible;
  padding: 10px;
  background-color: rgba(0, 0, 0, 0.7);
  border-radius: 8px;
  
  .grid-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    justify-items: center;
    margin-bottom: 20px;
    
    .grid-item {
      width: 100%;
      text-align: center;
      
      .result-text {
          display: inline-block;
          padding: 15px 20px;
          font-size: 32px;
          font-weight: bold;
          color: #fff;
          background-color: transparent; /* 透明背景 */
          border: 1px solid #ddd;
          border-radius: 4px;
          width: 90%;
          box-sizing: border-box;
          cursor: pointer;
          
          &:hover {
            background-color: rgba(255, 255, 255, 0.1);
          }
        }
    }
  }
  
  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 10px;
  }
}

/* 堆叠卡片效果样式 */
#stackedCardContainer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10001;
  background-color: rgba(0, 0, 0, 0.8);
}

.card-stack {
  position: relative;
  width: 80%;
  height: 60vh;
  max-width: 900px;
  max-height: 600px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.stacked-card {
  position: absolute;
  width: 100%;
  height: 100%;
  perspective: 1000px;
  cursor: default;
  transition: none; /* 移除过渡效果，避免自动翻转 */
}

.stacked-card.active {
  cursor: pointer;
}

.stacked-card:not(.active) {
  cursor: default;
  pointer-events: none;
}

.card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  /* 只在添加flipped类时才有过渡效果 */
}

/* 只有在明确添加flipped类时才翻转 */
.stacked-card.flipped .card-inner {
  transform: rotateY(180deg);
  transition: transform 0.6s;
}

/* 默认状态不翻转 */
.card-inner {
  transform: rotateY(0deg);
}

/* 飞出动画时保持翻转状态 */
.stacked-card.flying-out .card-inner {
  transform: rotateY(180deg);
  transition: transform 0.6s;
}

.card-front,
.card-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
}

/* 卡片正面（初始可见面）：点击揭晓 */
.card-front {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  border: 4px solid #ffd700;
  z-index: 2;
}

/* 卡片背面（翻转后可见面）：中奖信息 */
.card-back {
  background: linear-gradient(135deg, #16a085, #27ae60);
  border: 4px solid #ffd700;
  transform: rotateY(180deg);
  z-index: 1;
}

/* 卡片飞出动画 */
.stacked-card.flying-out {
  animation: flyOutLeft 0.6s forwards;
}

@keyframes flyOutLeft {
  0% {
    transform: translateX(0);
    opacity: 1;
    z-index: 1000;
  }
  100% {
    transform: translateX(-150%);
    opacity: 0;
    z-index: 0;
  }
}

.card-content {
  text-align: center;
  color: white;
  padding: 40px;
}

.card-front .card-content h2 {
  font-size: 60px;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.card-front .card-content p {
  font-size: 32px;
  opacity: 0.9;
}

.winner-name {
  font-size: 48px;
  font-weight: bold;
  margin-bottom: 30px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.winner-photo {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  border: 4px solid #ffd700;
  object-fit: cover;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}



/* 淡入淡出过渡效果 */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.5s;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
</style>
